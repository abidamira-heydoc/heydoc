rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Helper function to check if user is a platform admin (HeyDoc owner)
    function isPlatformAdmin() {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'platform_admin';
    }

    // Helper function to check if user is an org admin
    function isOrgAdmin() {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'org_admin';
    }

    // Helper function to check if user is any type of admin (backward compat)
    function isAnyAdmin() {
      return isAuthenticated() &&
             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'org_admin' ||
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'platform_admin');
    }

    // Legacy alias for backward compatibility
    function isAdmin() {
      return isAnyAdmin();
    }

    // Helper function to get current user's organizationId
    function getUserOrgId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId;
    }

    // Organizations - anyone can read (for code validation), platform admin or functions can write
    match /organizations/{orgId} {
      allow read: if true;
      allow write: if isPlatformAdmin(); // Platform admin can manage orgs
    }

    // Users collection
    match /users/{userId} {
      // Users can read their own doc
      // Org admins can read users in their org
      // Platform admins can read all users
      allow read: if isOwner(userId) ||
                    isPlatformAdmin() ||
                    (isOrgAdmin() && resource.data.organizationId == getUserOrgId());
      // Users can update their own profile, platform admin can update any user
      allow write: if isOwner(userId) || isPlatformAdmin();
    }

    // Medical history - users can read their own
    match /medicalHistory/{entryId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow write: if false; // Only cloud functions can write
    }

    // Health profiles - HIPAA protected
    // profileId should be the user's UID
    match /healthProfiles/{profileId} {
      allow read: if isAuthenticated() && request.auth.uid == profileId;
      allow create: if isAuthenticated() && request.auth.uid == profileId;
      allow update: if isAuthenticated() && request.auth.uid == profileId;
      allow delete: if isAuthenticated() && request.auth.uid == profileId;
    }

    // Conversations
    match /conversations/{conversationId} {
      // Users can read their own, admins can read conversations of users in their org
      allow read: if isAuthenticated() &&
                     (resource.data.userId == request.auth.uid ||
                      (isAdmin() &&
                       get(/databases/$(database)/documents/users/$(resource.data.userId)).data.organizationId == getUserOrgId()));
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
                               resource.data.userId == request.auth.uid;
    }

    // Messages (top-level collection)
    match /messages/{messageId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated();
    }

    // Consents - HIPAA/GDPR compliance
    match /consents/{consentId} {
      allow read: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid;
      // Consents cannot be deleted, only updated
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
    }

    // Audit logs - read-only for users
    match /auditLogs/{logId} {
      allow read: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid;
      allow write: if false; // Only cloud functions can write
    }

    // Knowledge base - public read, admin write only
    match /knowledgeBase/{docId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only cloud functions/admin can write
    }

    // Consultation sessions - users can read their own
    match /consultationSessions/{sessionId} {
      allow read: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid;
      allow write: if false; // Only cloud functions can write
    }

    // Payments - users can read their own
    match /payments/{paymentId} {
      allow read: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid;
      allow write: if false; // Only cloud functions can write
    }

    // Stripe event logs - no client access
    match /stripeEventLogs/{logId} {
      allow read, write: if false; // Only cloud functions can access
    }

    // ============================================================================
    // DOCTOR PORTAL COLLECTIONS
    // ============================================================================

    // Helper function to check if user is an approved doctor
    function isApprovedDoctor() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/doctors/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/doctors/$(request.auth.uid)).data.status == 'approved';
    }

    // Doctors collection
    match /doctors/{doctorId} {
      // Doctors can read/write their own profile (except status changes)
      allow read: if isAuthenticated() && request.auth.uid == doctorId;
      allow create: if isAuthenticated() && request.auth.uid == doctorId;
      allow update: if isAuthenticated() && request.auth.uid == doctorId &&
                       (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['status', 'approvedAt', 'rejectedAt']));
      // Platform admin can read all doctors and update status
      allow read: if isPlatformAdmin();
      allow update: if isPlatformAdmin();
      // Public read for available doctors (for patient selection)
      allow read: if isAuthenticated() && resource.data.status == 'approved' && resource.data.isAvailable == true;
    }

    // Consultation cases
    match /consultationCases/{caseId} {
      // Patients can read their own cases
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Doctors can read cases assigned to them or pending cases
      allow read: if isApprovedDoctor() &&
                     (resource.data.assignedDoctorId == request.auth.uid ||
                      resource.data.status == 'pending');
      // Doctors can update cases assigned to them
      allow update: if isApprovedDoctor() && resource.data.assignedDoctorId == request.auth.uid;
      // Only cloud functions can create/fully manage cases
      allow create: if false;
    }

    // Consultation messages (doctor-patient chat)
    match /consultationMessages/{messageId} {
      // Patients and assigned doctors can read messages for their cases
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.senderId == request.auth.uid;
    }

    // Doctor payouts - doctors can read their own
    match /doctorPayouts/{payoutId} {
      allow read: if isAuthenticated() && resource.data.doctorId == request.auth.uid;
      allow write: if false; // Only cloud functions can write
    }

    // Platform admins have full access to doctors collection
    match /doctors/{doctorId} {
      allow read, write: if isPlatformAdmin();
    }

    // Platform admin can read all consultation cases
    match /consultationCases/{caseId} {
      allow read: if isPlatformAdmin();
    }

    // Platform admin can read all payouts
    match /doctorPayouts/{payoutId} {
      allow read: if isPlatformAdmin();
    }
  }
}
